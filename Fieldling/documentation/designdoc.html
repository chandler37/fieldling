<HTML>
 <HEAD>
  <TITLE>QuillDriver Design Overview</TITLE>
  <STYLE>
   .code {font-family: courier}
  </STYLE>
 </HEAD>
 <BODY>
 <H2>QuillDriver</H2>
 <TABLE width="800" CELLPADDING="8" BORDER="1">
 <TD valign="top" width="150" BGCOLOR="#dddddd">
   <P><a href="index.html">Introduction</a></P>
   <P><a href="designdoc.html">Design Overview</a></P>
   <P><a href="developerdoc.html">Developer Guide</a></P>
   <P><a href="doc/api/index.html">Java API</a></P>
   <P><a href="downloads.html">Downloads</a></P>
   <P><a href="http://sourceforge.net/projects/fieldling">SourceForge Page</a></P>
   <P><a href="acknowledgements.html">Acknowledgements</a></P>
   <P><a href="gpl.txt">License</a></P>
 </TD>
 <TD valign="top">
  <H3>Design Overview</H3>
  <P>This document attempts to give a brief overview of QuillDriver's design,
  in lieu of quality technical documentation. Anybody who wants to get under
  the hood should probably start with this.</P>
  <H4>Building and Executing QuillDriver</H4>
  <P>You can get QuillDriver from <A HREF="http://sourceforge.net/projects/fieldling">SourceForge</A>.
  You'll need to first install Ant. Then check out the <span class="code">Fieldling</span> module. Change to the
  Fieldling directory and type <span class="code">ant qd-tibetan-run</span> to run the Tibetan version of QuillDriver.
  You can see other Ant targets by typing <span class="code">ant -projecthelp</span>.</P>
  <H4>A Map of the Source</H4>
  <P>First things first: if you try to compile QuillDriver without using Ant, you'll get
  a bunch of errors. That's because there are two versions of QuillDriver, one optimized (hacked)
  for Tibetan, and the other designed for multilingual use. The Tibetan version uses legacy
  non-Unicode encodings and fonts, and so uses a bunch of special code. Code that
  is only meant to compile in the Tibetan version is flagged with <span class="code">@TIBETAN@</span> and code that is
  only meant to compile in the multilingual version is flagged with <span class="code">@UNICODE@</span>. When you type
  <span class="code">ant qd-compile</span>, Ant uses filters to create two versions of each source code file and then compiles
  the Tibetan set and the Unicode set to separate directories. I would have made it modular but
  the Tibetan version is truly a freak of nature so this was virtuous enough.</P>
  <P>After running <span class="code">ant qd-compile</span>, look in the <span class="code">build/tibetan/classes</span> directory. You'll
  see a handful of xml configuration files, and a <span class="code">fieldling</span> directory. The QuillDriver
  application consists of three packages:</P>
  <UL>
   <LI><span class="code">fieldling.mediaplayer</span>: This package includes classes to play media files,
   including Quicktime for Java and Java Media Framework implementations.</LI>
   <LI><span class="code">fieldling.quilldriver</span>: This package contains the core QuillDriver classes,
   including an XML editor, various XML utilities, and the QuillDriver shell.</LI>
   <LI><span class="code">fieldling.util</span>: A collection of utility classes that will not be further 
   commented on.</LI>
  </UL>
  <H5><span class="code">fieldling.mediaplayer</span></H5>
  <P>The media player is responsible for playing audio or video files;
  receiving message requests to play a segment, pause, stop, and so forth; and sending
  messages to listeners concerning the current play point and the currently 'active'
  annotations. <span class="code">PanelPlayer</span> is an abstract class which specifies various media-related
  methods such as 'play', 'pause', and so forth to be defined in implementations.
  <span class="code">PanelPlayer</span> also includes fully defined methods responsible for handling 
  synchronization between the media and an <span class="code">AnnotationPlayer</span>. After an implementation
  of <span class="code">PanelPlayer</span> is instantiated it can be passed a series of (id, start, stop) tuples
  which correlate start and stop times with a set of ids. In QuillDriver, these ids
  refer to a node in the XML data file. <span class="code">PanelPlayer</span> sends messages to registered listeners
  letting them know whenever an annotation starts or stops.</P>
  <P>The mediaplayer package includes two implementations of <span class="code">PanelPlayer</span>, one for
  Java Media Framework, and one for Quicktime for Java. In addition, there's a factory
  class which keeps track of existing implementations and exploits reflection to locate all
  of them that are present on a given system. (For example if <span class="code">jmf.jar</span> can't be found then
  it won't be included on the list of active media players.)</P>
  <H5><span class="code">fieldling.quilldriver</span></H5>
  <P>On the one hand, this package contains QuillDriver's XML editor window. 
  This window reads in an XML file and renders it in a Swing JTextPane. Elements 
  and attributes are displayed according to parameters defined in a configuration 
  file (on which see below). The editor is vigilantly protective, which means that 
  only text and attribute nodes can be edited: element tags themselves cannot be 
  touched. The key editor classes are <span class="code">XMLEditor</span> and <span class="code">XMLTagInfo</span>.</P>
  <P><span class="code">TextPlayer</span> and <span class="code">TextHighlightPlayer</span> are classes that let
  a <span class="code">JTextComponent</span> sync up with a media player, so that annotations are highlighted
  as they are active. <span class="code">TwoWayTextPlayer</span> adds two way functionality so that one can
  click on something in the text component and the media player will respond.
  <span class="code">TranscriptView</span> offers a view of a transcript, while <span class="code">XMLView</span> is a view of an XML
  transcript. QuillDriver hooks <span class="code">XMLEditor</span> up to these classes so that XML nodes
  are highlighted as they become active (i.e. when the media player plays them).</P>
  <P>Finally, there's the QuillDriver overlay (<span class="code">QDShell</span> and <span class="code">QD</span>), which adds
  functionality on top of the media player and XML editor. It is responsible for two things:
  time-coding, and editing functionality. The time-coding apparatus is found in inner
  classes in <span class="code">QD</span>. The editing functionality is somewhat more complex. Instead of
  being specified directly, it is specified externally to QuillDriver within XML and
  XSL configuration files (see below).</P>
  <H4>Customizing QuillDriver</H4>
  <P>When QuillDriver loads up, it uses fieldling.quilldriver.ConfigurationFactory
  to locate all available 'configurations' or 'customizations'. The file <span class="code">qd-configurations.xml</span>
  specifies the available configurations. Each configuration specifies a mandatory
  XML configuration file, an optional XSL file defining editing functionality, and an
  XSL template for creating new XML files.</P>
  <P>An XML configuration follows the <span class="code">qd-configuration.dtd</span> DTD. Basically, it specifies:
  <OL>
   <LI>A set of parameters passed to QuillDriver.</LI>
   <LI>A set of actions which define the viewing, time-coding and editing functionality
   supported by the configuration.</LI>
   <LI>A set of rendering instructions saying how to display an XML file in the XML editor.</LI>
  </OL>
  Actions are associated with menus on the menu bar, with keyboard shortcuts, and with
  tasks in the XSL editing file.</P>
  <P>The XSL file defining editing functionality defines a series of editing tasks
  referenced by the XML configuration file. Each task uses XSLT to perform an operation
  on a node in the XML input. This is the only way to change an element tag in QuillDriver.</P>
  <P>Finally, the XSL template for creating new XML files defines what happens when you 
  choose to create a new annotation to associate with a media file you have opened.</P>
  <P>The customization process is powerful, but somewhat ad-hoc and also poorly documented.
  I am in the process of improving this documentation, and also planning to add an
  alternative/supplemental way to customize QuillDriver based on Jython scripting
  (scripting Java with Python).</P>
 </TD>
 </TABLE>
 </BODY>
</HTML>

